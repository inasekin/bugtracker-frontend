#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ staged —Ñ–∞–π–ª—ã
if git diff --cached --quiet; then
  echo "‚ö†Ô∏è  No staged changes found. Skipping pre-commit checks."
  exit 0
fi

# –ó–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–æ–≤ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–ª—å–∫–æ –¥–ª—è staged —Ñ–∞–π–ª–æ–≤
echo "üé® Running linters and formatters on staged files..."
npx lint-staged

if [ $? -ne 0 ]; then
  echo "‚ùå Linting/formatting failed. Please fix the issues and try again."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ TypeScript
echo "üîß Type checking..."
npm run type-check

if [ $? -ne 0 ]; then
  echo "‚ùå TypeScript type check failed. Please fix type errors before committing."
  echo "üí° Hint: Run 'npm run type-check' to see detailed errors."
  exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ console.log/debugger –≤ staged —Ñ–∞–π–ª–∞—Ö
echo "üîç Checking for console.log and debugger statements..."
staged_files=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$')

if [ ! -z "$staged_files" ]; then
  # –ü—Ä–æ–≤–µ—Ä—è–µ–º console.log (–∏—Å–∫–ª—é—á–∞—è console.warn –∏ console.error)
  console_logs=$(git diff --cached | grep -E '^\+.*console\.log\(')
  if [ ! -z "$console_logs" ]; then
    echo "‚ö†Ô∏è  Warning: Found console.log statements in staged files:"
    echo "$console_logs"
    echo "üí° Consider removing console.log before committing or use console.warn/console.error instead."
  fi

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º debugger
  debuggers=$(git diff --cached | grep -E '^\+.*debugger[;]*')
  if [ ! -z "$debuggers" ]; then
    echo "‚ùå Found debugger statements in staged files:"
    echo "$debuggers"
    echo "Please remove debugger statements before committing."
    exit 1
  fi
fi

echo "‚úÖ All pre-commit checks passed! üéâ"
