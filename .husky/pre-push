#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ðŸš€ Running pre-push checks..."

# ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ‚Ð¾Ð¼, ÐºÑƒÐ´Ð° Ð¿ÑƒÑˆÐ¸Ð¼
remote="$1"
url="$2"

echo "ðŸ“¡ Pushing to: $remote ($url)"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð´Ð»Ñ Ð¿ÑƒÑˆÐ°
if git log @{u}.. --oneline >/dev/null 2>&1; then
  commits_count=$(git log @{u}.. --oneline | wc -l)
  echo "ðŸ“¦ Found $commits_count commit(s) to push"
else
  echo "â„¹ï¸  No commits to push or no upstream branch set"
fi

# ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð»Ð¸Ð½Ñ‚Ð¸Ð½Ð³Ð° Ð²ÑÐµÐ³Ð¾ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°
echo "ðŸ” Running full project linting..."
npm run lint

if [ $? -ne 0 ]; then
  echo "âŒ Linting failed. Please fix all linting errors before pushing."
  echo "ðŸ’¡ Run 'npm run lint:fix' to auto-fix some issues."
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ‚Ð¸Ð¿Ð¾Ð²
echo "ðŸ”§ Running TypeScript type check..."
npm run type-check

if [ $? -ne 0 ]; then
  echo "âŒ TypeScript type check failed. Please fix type errors before pushing."
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
echo "ðŸŽ¨ Checking code formatting..."
npm run format:check

if [ $? -ne 0 ]; then
  echo "âŒ Code formatting check failed."
  echo "ðŸ’¡ Run 'npm run format' to fix formatting issues."
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ±Ð¾Ñ€ÐºÐ¸
echo "ðŸ—ï¸  Building project..."
npm run build

if [ $? -ne 0 ]; then
  echo "âŒ Build failed. Please fix build errors before pushing."
  exit 1
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° bundle (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ ÑÐ±Ð¾Ñ€ÐºÐ°)
if [ -d "dist" ]; then
  echo "ðŸ“Š Checking bundle size..."
  bundle_size=$(du -sh dist/ | cut -f1)
  echo "ðŸ“¦ Bundle size: $bundle_size"

  # ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ, ÐµÑÐ»Ð¸ bundle Ð±Ð¾Ð»ÑŒÑˆÐµ 10MB
  bundle_bytes=$(du -s dist/ | cut -f1)
  if [ $bundle_bytes -gt 10240 ]; then  # 10MB Ð² KB
    echo "âš ï¸  Warning: Bundle size is quite large ($bundle_size). Consider code splitting."
  fi
fi

# Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹ - Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¸Ñ…
if [ -d "src/__tests__" ] || [ -d "tests" ] || [ -d "__tests__" ]; then
  echo "ðŸ§ª Running tests..."
  npm run test

  if [ $? -ne 0 ]; then
    echo "âŒ Tests failed. Please fix failing tests before pushing."
    exit 1
  fi
else
  echo "â„¹ï¸  No tests found. Consider adding tests for better code quality."
fi

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° TODO/FIXME ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸Ð¸ Ð² Ð½Ð¾Ð²Ñ‹Ñ… ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ð°Ñ… (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ)
echo "ðŸ” Checking for TODO/FIXME comments in new commits..."
new_todos=$(git log @{u}.. --pretty=format: --name-only | sort -u | xargs grep -l "TODO\|FIXME" 2>/dev/null || true)
if [ ! -z "$new_todos" ]; then
  echo "ðŸ’¡ Found TODO/FIXME comments in:"
  echo "$new_todos" | sed 's/^/  - /'
  echo "Consider addressing these before releasing to production."
fi

echo ""
echo "âœ… All pre-push checks passed! ðŸŽ‰"
echo "ðŸš€ Ready to push to $remote"
